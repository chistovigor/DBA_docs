Группировка метрик MongoDB для Grafana Dashboard
Панель 1: Производительность и основные показатели
1. collector_scrape_time_ms
Единица измерения: миллисекунды (ms)
Описание: Время сбора метрик различными коллекторами. Высокие значения могут указывать на проблемы производительности MongoDB или сети.
Метрики:

collector_scrape_time_ms{collector="diagnostic_data"} - особенно важно, так как диагностические данные требуют глубокого анализа

collector_scrape_time_ms{collector="top"} - мониторинг операций в реальном времени

2. mongodb_asserts_total
Единица измерения: количество (count)
Описание: Количество утверждений (asserts) в MongoDB. Высокие значения указывают на внутренние ошибки или проблемы с данными.
Ключевая метрика:

mongodb_asserts_total{type="user"} - пользовательские asserts (1.46M в логе) - критически важно отслеживать

3. mongodb_clusterTime_clusterTime
Единица измерения: timestamp (секунды с эпохи Unix)
Описание: Время кластера MongoDB, важно для мониторинга репликации и согласованности данных.

Панель 2: Использование памяти и сборка мусора
4. go_memstats_heap_alloc_bytes
Единица измерения: байты (bytes)
Описание: Текущее использование heap-памяти экспортером. Резкий рост может указывать на утечку памяти.

5. go_memstats_heap_inuse_bytes
Единица измерения: байты (bytes)
Описание: Размер heap-памяти, активно используемой экспортером.

6. go_memstats_heap_idle_bytes
Единица измерения: байты (bytes)
Описание: Размер неиспользуемой heap-памяти, которая может быть возвращена ОС.

7. go_gc_duration_seconds
Единица измерения: секунды (seconds)
Описание: Время, затраченное на сборку мусора. Длительные паузы GC влияют на производительность.
Метрики:

go_gc_duration_seconds{quantile="1"} - максимальное время паузы GC

go_gc_duration_seconds_sum - общее время, потраченное на GC

Панель 3: Кэш WiredTiger
8. mongodb_config_image_collection_stats_storageStats_indexDetails_id_cache_bytes_currently_in_the_cache
Единица измерения: байты (bytes)
Описание: Текущий размер данных в кэше для индекса id. Низкие значения могут указывать на нехватку кэша.

9. mongodb_config_image_collection_stats_storageStats_indexDetails_id_cache_pages_requested_from_the_cache
Единица измерения: количество страниц (count)
Описание: Количество запросов страниц из кэша. Высокие значения указывают на хорошую эффективность кэша.

10. mongodb_config_image_collection_stats_storageStats_wiredTiger_cache_bytes_currently_in_the_cache
Единица измерения: байты (bytes)
Описание: Общий размер данных в кэше WiredTiger. Ключевой показатель эффективности кэширования.

Панель 4: Операции с курсорами
11. mongodb_config_image_collection_stats_storageStats_indexDetails_id_cursor_next_calls
Единица измерения: количество операций (count)
Описание: Количество операций cursor.next(). Высокие значения могут указывать на неоптимальные запросы.

12. mongodb_config_image_collection_stats_storageStats_indexDetails_id_cursor_reset_calls
Единица измерения: количество операций (count)
Описание: Количество сбросов курсоров. Может указывать на проблемы с управлением курсорами.

13. mongodb_config_image_collection_stats_storageStats_indexDetails_id_cursor_cache_cursors_reuse_count
Единица измерения: количество использований (count)
Описание: Количество повторного использования кэшированных курсоров. Высокие значения показывают эффективность использования ресурсов.

Панель 5: Размеры данных и индексов
14. mongodb_config_image_collection_stats_storageStats_size
Единица измерения: байты (bytes)
Описание: Размер данных коллекции. Мониторинг роста данных важен для планирования ресурсов.

15. mongodb_config_image_collection_stats_storageStats_storageSize
Единица измерения: байты (bytes)
Описание: Фактический размер хранилища, занимаемый коллекцией.

16. mongodb_config_image_collection_stats_storageStats_totalIndexSize
Единица измерения: байты (bytes)
Описание: Общий размер всех индексов коллекции. Индексы могут занимать значительное пространство.

17. mongodb_config_image_collection_stats_storageStats_totalSize
Единица измерения: байты (bytes)
Описание: Общий размер данных и индексов. Критически важно для мониторинга использования диска.

Панель 6: Эффективность индексов
18. mongodb_config_image_collection_stats_storageStats_nindexes
Единица измерения: количество индексов (count)
Описание: Количество индексов в коллекции. Слишком много индексов может замедлять запись.

19. mongodb_config_image_collection_stats_storageStats_indexDetails_id_btree_maximum_tree_depth
Единица измерения: уровни (levels)
Описание: Максимальная глубина B-дерева индекса. Большая глубина может снижать производительность поиска.

20. mongodb_config_image_collection_stats_storageStats_indexSizes_id
Единица измерения: байты (bytes)
Описание: Размер индекса _id. Базовый индекс, который есть в каждой коллекции.

Рекомендации по настройке алертинга:
Установите предупреждения для:

Резкого роста mongodb_asserts_total (более 1000/мин)

Увеличения времени сбора метрик более 500ms

Снижения эффективности кэша (hit ratio ниже 90%)

Быстрого роста размера данных или индексов (более 10% в час)

Увеличения времени пауз GC более 100ms

Настройте разные уровни серьезности для:

Критических метрик (asserts, использование памяти)

Предупреждающих метрик (размер данных, эффективность кэша)

Информационных метрик (статистика использования)

Такой дашборд предоставит комплексное представление о состоянии MongoDB и поможет быстро выявлять проблемы с производительностью, памятью, хранилищем и эффективностью запросов.
