// ----------------------------
// MongoDB Disk Usage Analysis
// ----------------------------

// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —á–µ—Ä–µ–∑ --eval)
var TOP_N_DB = typeof TOP_N_DB !== 'undefined' ? TOP_N_DB : {{ mongo_top_n_db | default(5) }};
var TOP_N_COLL = typeof TOP_N_COLL !== 'undefined' ? TOP_N_COLL : {{ mongo_top_n_coll | default(5) }};
var MIN_MB = typeof MIN_MB !== 'undefined' ? MIN_MB : {{ mongo_min_mb | default(1) }};

// –†–∞–∑—Ä–µ—à–∞–µ–º —á—Ç–µ–Ω–∏–µ —Å–æ secondary
db.getMongo().setReadPref('secondaryPreferred');

// ----------------------------
// Helper Functions
// ----------------------------
function toMB(bytes) {
    return bytes / 1024 / 1024;
}

// ----------------------------
// –í—ã–≤–æ–¥ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –ë–î
// ----------------------------
try {
    let dbPath = db.serverCmdLineOpts().parsed.storage.dbPath;
    print(`[DATA DIR] MongoDB Data Directory: ${dbPath}\n`);
} catch (e) {
    print(`[WARNING] –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—É—Ç—å –∫ —Ñ–∞–π–ª–∞–º –ë–î: ${e.message}\n`);
}

print(`[INFO] Running MongoDB disk usage analysis (TOP_N_DB=${TOP_N_DB}, TOP_N_COLL=${TOP_N_COLL}, MIN_MB=${MIN_MB}MB)`);
print(`[INFO] Collections and indexes smaller than ${MIN_MB} MB will be skipped.\n`);

// ----------------------------
// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –±–∞–∑–∞–º
// ----------------------------
let dbInfos = [];
let totalAllDBs = 0;

db.getMongo().getDBNames().forEach(dbName => {
    try {
        let database = db.getSiblingDB(dbName);
        let stats = database.stats(1024*1024);
        let total = stats.storageSize + stats.indexSize;
        totalAllDBs += total;
        dbInfos.push({
            name: dbName,
            storage: stats.storageSize,
            data: stats.dataSize,
            index: stats.indexSize,
            total: total
        });
    } catch (e) {
        print(`[WARNING] Skipping ${dbName}: ${e.message}`);
    }
});

// –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–∞–∑–º–µ—Ä—É –±–∞–∑
dbInfos.sort((a, b) => b.total - a.total);

// –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –¢–û–ü N –±–∞–∑
let topDBs = dbInfos.slice(0, TOP_N_DB);

print("=== [DATABASE] Top Databases by Disk Usage (MB) ===");
let totalTopN = 0;
topDBs.forEach((info, i) => {
    totalTopN += info.total;
    print(`${i+1}. ${info.name} ‚Üí total_on_disk=${info.total.toFixed(2)} MB (storage=${info.storage.toFixed(2)} MB, data(logical)=${info.data.toFixed(2)} MB, index=${info.index.toFixed(2)} MB)`);
});

print(`\n[TOTAL] Total disk usage for all databases: ${totalAllDBs.toFixed(2)} MB`);
print(`[TOTAL] Total disk usage for top ${TOP_N_DB} databases: ${totalTopN.toFixed(2)} MB\n`);

// ----------------------------
// –ê–Ω–∞–ª–∏–∑ –¢–û–ü M –∫–æ–ª–ª–µ–∫—Ü–∏–π —Ç–æ–ª—å–∫–æ –¥–ª—è –¢–û–ü N –±–∞–∑
// ----------------------------
topDBs.forEach(dbInfo => {
    let database = db.getSiblingDB(dbInfo.name);
    print(`=== [COLLECTIONS] Top ${TOP_N_COLL} Collections for DB: ${dbInfo.name} ===`);
    try {
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ MIN_MB
        let collections = database.getCollectionNames().map(collName => {
            try {
                let stats = database.getCollection(collName).stats(1024*1024);
                return {
                    name: collName,
                    storage: stats.storageSize,
                    data: stats.size,
                    index: stats.totalIndexSize,
                    indexes: stats.indexSizes
                };
            } catch (e) {
                print(`[WARNING] Skipping ${dbInfo.name}.${collName}: ${e.message}`);
                return null;
            }
        }).filter(c => c && (c.storage >= MIN_MB || c.data >= MIN_MB || c.index >= MIN_MB));

        // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–∞–∑–º–µ—Ä—É –∫–æ–ª–ª–µ–∫—Ü–∏–π
        collections.sort((a, b) => b.storage - a.storage);

        // üîπ –∞–Ω–∞–ª–∏–∑ —Ç–æ–ª—å–∫–æ –¢–û–ü M –∫–æ–ª–ª–µ–∫—Ü–∏–π –∫–∞–∂–¥–æ–π –±–∞–∑—ã
        collections.slice(0, TOP_N_COLL).forEach((c, idx) => {
            print(`${idx+1}. ${c.name} ‚Üí coll(storage)=${c.storage.toFixed(2)} MB, indexes=${c.index.toFixed(2)} MB, data(logical)=${c.data.toFixed(2)} MB${c.data===0 ? " [WARNING] data(logical)=0 may indicate missing stats on secondary or empty collection." : ""}`);
            
            // –≤—ã–≤–æ–¥ –∏–Ω–¥–µ–∫—Å–æ–≤
            print("   ‚Üí Indexes:");
            for (let [indexName, size] of Object.entries(c.indexes)) {
                if (size >= MIN_MB) {
                    print(`      ${indexName}: ${size.toFixed(2)} MB`);
                }
            }

            // üîπ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –º–µ—Å—Ç–∞
            let wasted = c.storage - c.data - c.index;
            if (wasted >= MIN_MB) {
                print(`   ‚ö†Ô∏è Potential reclaimable space: ${wasted.toFixed(2)} MB`);
                print(`     Run on DB "${dbInfo.name}": db.getCollection("${c.name}").compact()`);
            }
        });
        print("");
    } catch (e) {
        print(`[WARNING] Error processing collections for DB ${dbInfo.name}: ${e.message}`);
    }
});

// ----------------------------
// End of Script
// ----------------------------
