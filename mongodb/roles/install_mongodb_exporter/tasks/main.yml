---
- name: Ensure installation directories exist
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /usr/local/bin

#####################
# MongoDB Exporter
#####################

- name: Download MongoDB Exporter
  get_url:
    url: "https://github.com/percona/mongodb_exporter/releases/download/v{{ mongodb_exporter_version }}/mongodb_exporter-{{ mongodb_exporter_version }}.linux-amd64.tar.gz"
    dest: /tmp/mongodb_exporter.tar.gz
    mode: '0644'

- name: Extract MongoDB Exporter
  unarchive:
    src: /tmp/mongodb_exporter.tar.gz
    dest: /tmp
    remote_src: true
    creates: "/tmp/mongodb_exporter-{{ mongodb_exporter_version }}.linux-amd64/mongodb_exporter"

- name: Install MongoDB Exporter binary
  copy:
    src: "/tmp/mongodb_exporter-{{ mongodb_exporter_version }}.linux-amd64/mongodb_exporter"
    dest: /usr/local/bin/mongodb_exporter
    owner: root
    group: root
    mode: '0755'
    remote_src: true
  notify: restart mongodb_exporter

- name: Create environment configuration file
  template:
    src: mongodb_exporter.env.j2
    dest: /etc/default/mongodb_exporter
    owner: root
    group: root
    mode: '0600'
  notify: restart mongodb_exporter

- name: Create systemd service
  template:
    src: mongodb_exporter.service.j2
    dest: /etc/systemd/system/mongodb_exporter.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload systemd
    - restart mongodb_exporter

#####################
# Node Exporter
#####################

- name: Download Node Exporter
  get_url:
    url: "https://github.com/prometheus/node_exporter/releases/download/v{{ node_exporter_version }}/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz"
    dest: /tmp/node_exporter.tar.gz
    mode: '0644'

- name: Extract Node Exporter
  unarchive:
    src: /tmp/node_exporter.tar.gz
    dest: /tmp
    remote_src: true
    creates: "/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64/node_exporter"

- name: Install Node Exporter binary
  copy:
    src: "/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64/node_exporter"
    dest: /usr/local/bin/node_exporter
    owner: root
    group: root
    mode: '0755'
    remote_src: true
  notify: restart node_exporter

- name: Create Node Exporter environment configuration file
  template:
    src: node_exporter.env.j2
    dest: /etc/default/node_exporter
    owner: root
    group: root
    mode: '0600'
  notify: restart node_exporter

- name: Create Node Exporter systemd service
  template:
    src: node_exporter.service.j2
    dest: /etc/systemd/system/node_exporter.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload systemd
    - restart node_exporter

- name: Check if nftables config directory exists
  stat:
    path: /etc/nftables
  register: nftables_dir

- name: Add MongoDB Exporter port to nftables configuration
  block:
    - name: Find the config file
      find:
        paths: /etc/nftables
        patterns: "*-filter.nft"
      register: nftables_config_files

- name: Set config file path
  set_fact:
    nftables_config: "{{ (nftables_config_files.files | first).path | default('/etc/nftables/ipv4-filter.nft') }}"

# Проверяем и добавляем порт MongoDB Exporter
- name: Check if port already exists in config
  command: grep -q "elements = {.*{{ mongodb_exporter_port }}.*}" "{{ nftables_config }}"
  register: port_exists
  failed_when: false
  changed_when: false

- name: Ensure MongoDB Exporter port is present ONLY in firewall_open_tcp_ports
  replace:
    path: "{{ nftables_config }}"
    regexp: '(^\s*set firewall_open_tcp_ports\s*\{[^}]*elements\s*=\s*\{)([^}]*)\}'
    replace: '\1\2, {{ mongodb_exporter_port }}}'
  when: port_exists.rc != 0

# Проверяем и добавляем порт Node Exporter
- name: Check if Node Exporter port already exists
  command: grep -q "elements = {.*{{ node_exporter_port }}.*}" "{{ nftables_config }}"
  register: node_exporter_port_exists
  failed_when: false
  changed_when: false

- name: Ensure Node Exporter port is present ONLY in firewall_open_tcp_ports
  replace:
    path: "{{ nftables_config }}"
    regexp: '(^\s*set firewall_open_tcp_ports\s*\{[^}]*elements\s*=\s*\{)([^}]*)\}'
    replace: '\1\2, {{ node_exporter_port }}}'
  when: node_exporter_port_exists.rc != 0

- name: Restart nftables to apply changes
  systemd:
    name: nftables
    state: restarted
  when:
    - nftables_dir.stat.exists
    - port_exists.rc != 0

- name: Enable and start MongoDB Exporter service
  systemd:
    name: mongodb_exporter
    enabled: true
    state: started
    daemon_reload: true

- name: Check if UFW is active
  stat:
    path: /etc/ufw/ufw.conf
  register: ufw_config

# Проверяем наличие UFW
- name: Check if UFW is installed
  stat:
    path: /etc/ufw/ufw.conf
  register: ufw_config

# Получаем статус UFW (не падаем, если UFW выключен)
- name: Get UFW status
  command: ufw status
  register: ufw_status
  changed_when: false
  failed_when: false
  when: ufw_config.stat.exists

# Настраиваем правило только если UFW реально активен
- name: Configure UFW for MongoDB Exporter
  ufw:
    rule: allow
    port: "{{ mongodb_exporter_port }}"
    proto: tcp
    comment: "MongoDB Exporter"
  when:
    - ufw_config.stat.exists
    - "'Status: active' in ufw_status.stdout"

- name: Clean up temporary files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/mongodb_exporter.tar.gz
    - "/tmp/mongodb_exporter-{{ mongodb_exporter_version }}.linux-amd64"

- name: Verify IPv4 listening
  shell: |
    PORT={{ item }}
    if netstat -tln | grep -E ":${PORT}\s" | grep -q '0.0.0.0'; then
      echo "IPv4_OK"
    elif ss -tln | grep -E ":${PORT}\s" | grep -q '0.0.0.0'; then
      echo "IPv4_OK"
    else
      echo "IPv4_FAIL"
    fi
  register: ipv4_check
  changed_when: false
  loop:
    - "{{ mongodb_exporter_port }}"
    - "{{ node_exporter_port }}"

- name: Display IPv4 listening status
  debug:
    msg: "Exporter on port {{ item.item }} is listening on IPv4: {{ item.stdout }}"
  loop: "{{ ipv4_check.results }}"

- name: Verify ports in nftables rules
  shell: nft list ruleset | grep -q "{{ item }}"
  register: nftables_port_check
  changed_when: false
  failed_when: false
  loop:
    - "{{ mongodb_exporter_port }}"
    - "{{ node_exporter_port }}"

- name: Display nftables port verification
  debug:
    msg: "Port {{ item.item }} found in nftables: {{ 'yes' if item.rc == 0 else 'no' }}"
  loop: "{{ nftables_port_check.results }}"

- name: Check external connectivity
  wait_for:
    host: "{{ ansible_default_ipv4.address }}"
    port: "{{ item }}"
    timeout: 30
    delay: 5
  delegate_to: localhost
  become: no
  register: port_check
  until: port_check is success
  retries: 3
  delay: 10
  ignore_errors: yes
  loop:
    - "{{ mongodb_exporter_port }}"
    - "{{ node_exporter_port }}"

- name: Display port check results
  debug:
    msg: >-
      Port {{ item.item }} is {{
        'accessible externally' if item is success
        else 'NOT accessible externally. Check cloud provider firewall.'
      }}
  loop: "{{ port_check.results }}"


