function onOpen() {
  SpreadsheetApp.getUi().createMenu("üì• –≠–∫—Å–ø–æ—Ä—Ç Mongo")
    .addItem("–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –∏ –ø–æ–ª—É—á–∏—Ç—å CSV", "copyAndHighlightCellDifferences")
    .addToUi();
}

function copyAndHighlightCellDifferences() {
  // === üîß –ù–ê–°–¢–†–û–ô–ö–ò ===
  const sourceFileId = "1ZhePm3a8qWXuzSqN5tSSU5dqfxD9UX2gJFhBxtMZX1g"; // –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª
  const sourceSheetName = "Inventory";             // –ª–∏—Å—Ç-–∏—Å—Ç–æ—á–Ω–∏–∫
  const updateSheetName = "inventory_updates";  // –ö—É–¥–∞ –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å—Å—ã–ª–∫–∏
  const maxSheets = 24;                         // –•—Ä–∞–Ω–∏–º –º–∞–∫—Å–∏–º—É–º 24 –ª–∏—Å—Ç–∞
  const columnOrder = [3, 1, 2, 5];             // –ü–æ—Ä—è–¥–æ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤ (–Ω–æ–≤—ã–π = —Å—Ç–∞—Ä—ã–π[3,1,2,5])

  // === üìÇ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç ===
  const sourceSs = (sourceFileId === "SOURCE_SPREADSHEET_ID")
    ? SpreadsheetApp.getActiveSpreadsheet()
    : SpreadsheetApp.openById(sourceFileId);
  const sourceSheet = sourceSs.getSheetByName(sourceSheetName);
  if (!sourceSheet) {
    SpreadsheetApp.getUi().alert("–ù–µ –Ω–∞–π–¥–µ–Ω –ª–∏—Å—Ç-–∏—Å—Ç–æ—á–Ω–∏–∫: " + sourceSheetName);
    return;
  }

  // === üìã –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ (–±–µ–∑ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏) ===
  const lastRow = sourceSheet.getLastRow();
  const lastCol = sourceSheet.getLastColumn();
  if (lastRow < 2) {
    SpreadsheetApp.getUi().alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.");
    return;
  }
  const sourceValues = sourceSheet.getRange(2, 1, lastRow - 1, lastCol).getValues();
  const reorderedValues = sourceValues.map(row => columnOrder.map(i => row[i]));

  // === üïí –ò–º—è –ª–∏—Å—Ç–∞ –∏ CSV-—Ñ–∞–π–ª–∞ ===
  const now = new Date();
  const sheetName = Utilities.formatDate(now, Session.getScriptTimeZone(), "yyyy-MM-dd_HH-mm");

  // === üìò –ò—â–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º mongo_servers_csv ===
  let files = DriveApp.getFilesByName("mongo_servers_csv");
  let targetSs;
  if (files.hasNext()) {
    targetSs = SpreadsheetApp.open(files.next());
  } else {
    targetSs = SpreadsheetApp.create("mongo_servers_csv");
  }

  // === üßæ –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –ª–∏—Å—Ç ===
  let finalSheetName = sheetName;
  if (targetSs.getSheetByName(finalSheetName)) {
    let n = 1;
    while (targetSs.getSheetByName(finalSheetName + "_" + n)) n++;
    finalSheetName = finalSheetName + "_" + n;
  }
  const targetSheet = targetSs.insertSheet(finalSheetName);
  targetSheet.getRange(1, 1, reorderedValues.length, reorderedValues[0].length).setValues(reorderedValues);

  // === üîç –ü–æ–∏—Å–∫ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ª–∏—Å—Ç–æ–≤ ===
  const allSheets = targetSs.getSheets();
  const tsPattern = /^\d{4}-\d{2}-\d{2}_\d{2}-\d{2}(_\d+)?$/;
  let tsSheets = allSheets.filter(s => tsPattern.test(s.getName())).sort((a, b) => a.getName().localeCompare(b.getName()));
  const newestIndex = tsSheets.findIndex(s => s.getName() === targetSheet.getName());
  const prevSheet = (newestIndex > 0) ? tsSheets[newestIndex - 1] : null;
  const prePrevSheet = (newestIndex > 1) ? tsSheets[newestIndex - 2] : null;

  // === ‚öñÔ∏è –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π ===
  function norm(v) {
    if (v === null || v === undefined) return "";
    return String(v).trim();
  }

  // === üåà –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π ===
  let changedCount = 0;
  let prevData = null, prePrevData = null;
  if (prevSheet) prevData = prevSheet.getDataRange().getValues();
  if (prePrevSheet) prePrevData = prePrevSheet.getDataRange().getValues();

  if (prevData) {
    for (let r = 0; r < reorderedValues.length; r++) {
      const newRow = reorderedValues[r];
      const prevRow = prevData[r] || [];
      const prePrevRow = prePrevData ? (prePrevData[r] || []) : null;

      for (let c = 0; c < newRow.length; c++) {
        const newVal = norm(newRow[c]);
        const prevVal = norm(prevRow[c]);
        const prePrevVal = prePrevRow ? norm(prePrevRow[c]) : null;

        const changedNow = newVal !== prevVal;
        const prevWasDifferent = (prePrevRow !== null) && (prevVal !== prePrevVal);
        const alreadyRecorded = prevWasDifferent && (newVal === prevVal);

        if (changedNow && !alreadyRecorded) {
          targetSheet.getRange(r + 1, c + 1).setBackground("#FFFF00");
          changedCount++;
        }
      }
    }
  }

  // === üß± –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ CSV) ===
  try {
    targetSheet.autoResizeColumns(1, reorderedValues[0].length);
    targetSheet.setFrozenRows(1);
  } catch (e) {}

  // === üßπ –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ª–∏—Å—Ç—ã (–º–∞–∫—Å. 24) ===
  if (tsSheets.length > maxSheets) {
    while (tsSheets.length > maxSheets) {
      const oldest = tsSheets.shift();
      targetSs.deleteSheet(oldest);
    }
  }

  // === üíæ –°–æ–∑–¥–∞—ë–º CSV-—Ñ–∞–π–ª ===
  const csvName = "mongo_servers_" + sheetName + ".csv";
  const csvContent = reorderedValues.map(r =>
    r.map(v => `"${(v ?? "").toString().replace(/"/g, '""')}"`).join(",")
  ).join("\n");
  const csvFile = DriveApp.createFile(csvName, csvContent, MimeType.CSV);

  // === üîó –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ ===
  const csvDownloadUrl = "https://drive.google.com/uc?export=download&id=" + csvFile.getId();

  // === üìã –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π ===
  let updateSheet = sourceSs.getSheetByName(updateSheetName);
  if (!updateSheet) updateSheet = sourceSs.insertSheet(updateSheetName);
  updateSheet.appendRow([csvDownloadUrl, changedCount]);

  // === ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ===
  SpreadsheetApp.getUi().alert(
    "‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ª–∏—Å—Ç: " + finalSheetName +
    "\n‚úÖ CSV-—Ñ–∞–π–ª: " + csvName +
    "\nüìä –ò–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —è—á–µ–µ–∫: " + changedCount +
    "\nüîó –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ:\n" + csvDownloadUrl
  );
}
