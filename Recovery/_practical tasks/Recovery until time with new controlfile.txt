-- включение логирования

SPOOL LOG TO 'G:\Backup\recover_until_time.log';

-- создаем службу БД и spfile, прописываем ее в листенере, стартуем службу, затем в RMAN

connect target;

startup nomount;

-- восстанавливаем контролфайл из имеющегося бекапа (он новее, чем бекап остальных файлов)

restore controlfile from 'G:\Backup\CTL_AUTO_C-4101235284-20130410-00.BCK';

-- монтируем контролфайл для чтения информации о восстановлении из него

alter database mount;

-- добавляем в него информацию о имеющихся бекапах (из которых будет восстановление)

catalog start with 'G:\Backup\20130311';

-- делаем проверку на отсутствующие бекапы (информация о которых есть в контролфайле, но они недоступны на момент восстановления)

crosscheck backup;

-- удаляем информацию о недостапных бекапах

delete expired backup;

-- выводим обновленный (с учетом последних изменений) список бекапов

list backup;

-- проверяем имеющиеся в бекапах архивлоги

restore archivelog all preview;

-- проверяем возможность восстановить БД из имеющихся бекапов (физически не меняя ничего в файлах БД)!

restore database preview summary;

-- проверяем возможность восстановить БД из имеющихся бекапов до указанного момента времени (физически не меняя ничего в файлах БД)!

RUN
{
  set until time "to_date('2013-03-11 02:00:00', 'yyyy-mm-dd hh24:mi:ss')";
  RESTORE DATABASE preview summary;
  RECOVER DATABASE preview summary;
}

-- выполняем восстановление БД до указанной в логе резервного копирования последней актуальной SCN файлов данных

RUN
{
  SET UNTIL SCN=9182205767568;
  RESTORE DATABASE;
  RECOVER DATABASE;
}

-- после этого скорее всего понадобится выполнить в RMAN команды по восстановлению имеющихся в архивной копии логов
-- это однозначно следует делать при возникновении ошибки ORA-01194 при выполнении открытия БД с resetlogs
-- информацию о номерах sequence и THREAD взять из имеющегося лога архивации восстанавливаемой копии RMAN

RESTORE ARCHIVELOG sequence BETWEEN 399000 AND 400000 THREAD 1;

-- затем выполнить команду для восстановления БД в SQLPLUS сначала используя AUTO для предлагаемых логов а затем CANCEL

RECOVER DATABASE UNTIL CANCEL USING BACKUP CONTROLFILE;

-- открываем БД со сбросом реду-логов

alter database open resetlogs;

-- выключаем логирование

SPOOL LOG OFF;

-- выходим и проверяем БД

exit;






